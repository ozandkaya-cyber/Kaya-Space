<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mathe √úbungsplattform Klasse 2 und 3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700;800&amp;family=Nunito:wght@400;600;700;800&amp;display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-a: #dcefe0;
      --bg-b: #dfeaff;
      --panel: #ffffff;
      --line: #e7ddd0;
      --ink: #12222d;
      --muted: #5b6470;
      --brand: #0d6447;
      --brand2: #154a87;
      --brand-dark: #0a523a;
      --accent: #f16a2d;
      --accent-soft: #fff1e8;
      --ok: #12753d;
      --ok-soft: #e7f8ef;
      --bad: #b82f2b;
      --bad-soft: #fdeceb;
      --shadow: 0 14px 34px rgba(31, 41, 55, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Nunito", "Avenir Next", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 12% 8%, var(--bg-a) 0%, transparent 30%),
        radial-gradient(circle at 90% 16%, var(--bg-b) 0%, transparent 28%),
        linear-gradient(180deg, #f8f4ed, #f1e9dd);
      padding: 18px;
    }

    .app {
      max-width: 1020px;
      margin: 0 auto;
      background: #fffdf8;
      border: 1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .top {
      padding: 22px 22px 12px;
      background:
        linear-gradient(120deg, rgba(13, 100, 71, 0.12), rgba(21, 74, 135, 0.08)),
        #fcfffe;
      border-bottom: 1px solid #e0d6c9;
    }

    .badge {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid #b9dbc7;
      background: #e8f7ef;
      color: var(--brand);
      font-weight: 800;
      font-size: 0.8rem;
      letter-spacing: 0.02em;
      padding: 4px 12px;
      margin: 0;
      white-space: nowrap;
    }

    .brand-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .brand-lockup {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-height: 56px;
    }

    .brand-logo {
      display: block;
      height: clamp(44px, 7vw, 78px);
      width: auto;
      max-width: min(520px, 82vw);
      object-fit: contain;
    }

    .brand-fallback {
      display: none;
      padding: 7px 12px;
      border-radius: 10px;
      border: 1px solid #b9dbc7;
      background: #e8f7ef;
      color: var(--brand);
      font-weight: 800;
      letter-spacing: 0.01em;
    }

    .brand-lockup.no-logo .brand-logo {
      display: none;
    }

    .brand-lockup.no-logo .brand-fallback {
      display: inline-flex;
    }

    h1 {
      margin: 0;
      font-family: "Baloo 2", "Nunito", sans-serif;
      font-size: clamp(1.55rem, 4vw, 2.2rem);
      line-height: 1.1;
      color: #143528;
    }

    .lead {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 1rem;
      max-width: 84ch;
    }

    .content {
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      align-items: end;
    }

    .field {
      grid-column: span 12;
    }

    .field label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.86rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: #1f3d4c;
    }

    select,
    input[type="number"] {
      width: 100%;
      border-radius: 11px;
      border: 1px solid #c5d4cf;
      padding: 11px 12px;
      font: inherit;
      color: #12303c;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    select:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #0a8f78;
      box-shadow: 0 0 0 3px rgba(10, 143, 120, 0.14);
    }

    .mode-group {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 2px;
      scrollbar-width: thin;
      scrollbar-color: #b7c9c2 transparent;
    }

    .mode-group::-webkit-scrollbar {
      height: 7px;
    }

    .mode-group::-webkit-scrollbar-thumb {
      background: #c8d6d1;
      border-radius: 999px;
    }

    .mode-btn {
      border: 1px solid #b7c9c2;
      border-radius: 999px;
      background: #f6fbf9;
      color: #294753;
      padding: 8px 10px;
      font: inherit;
      font-size: 0.91rem;
      font-weight: 800;
      white-space: nowrap;
      flex: 0 0 auto;
      cursor: pointer;
      transition: transform 0.14s ease, border-color 0.2s ease, background 0.2s ease;
    }

    .mode-btn:hover {
      transform: translateY(-1px);
      border-color: #92b6ab;
    }

    .mode-btn.active {
      background: linear-gradient(120deg, #0d6447, #154a87);
      color: #fff;
      border-color: #0d6447;
      box-shadow: 0 10px 16px rgba(13, 100, 71, 0.25);
    }

    .auto-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.93rem;
      color: #264752;
      font-weight: 700;
      padding: 8px 10px;
      border: 1px dashed #b7cbc4;
      border-radius: 12px;
      background: #f8fcfa;
    }

    .auto-wrap input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #0a8f78;
    }

    .workspace {
      display: grid;
      gap: 14px;
      grid-template-columns: 1.45fr 1fr;
    }

    .task-card {
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .chip {
      border: 1px solid #c8d9d3;
      border-radius: 999px;
      background: #f4fbf8;
      padding: 4px 10px;
      font-size: 0.82rem;
      font-weight: 800;
      color: #1f4a56;
    }

    .equation {
      margin: 4px 0 12px;
      font-family: "Baloo 2", "Nunito", sans-serif;
      font-size: clamp(1.9rem, 4.2vw, 2.7rem);
      color: #102a3d;
      line-height: 1.06;
      letter-spacing: 0.01em;
    }

    .answer-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
      align-items: center;
    }

    .btn {
      border: 0;
      border-radius: 11px;
      font: inherit;
      font-weight: 800;
      padding: 11px 14px;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-main {
      background: linear-gradient(120deg, #154a87, #0f3f76);
      color: #fff;
      box-shadow: 0 11px 18px rgba(21, 74, 135, 0.23);
    }

    .btn-ghost {
      background: #edf5f2;
      color: #1f4251;
      border: 1px solid #c5d7d1;
    }

    .btn-warn {
      background: #fff4ea;
      color: #97451f;
      border: 1px solid #f5c3a5;
    }

    .sub-actions {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .feedback {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid #d6dfdb;
      background: #f7fbf9;
      padding: 10px 11px;
      min-height: 46px;
      font-weight: 700;
      color: #2f4e58;
      display: flex;
      align-items: center;
    }

    .feedback.ok {
      border-color: #a6ddba;
      background: var(--ok-soft);
      color: #15582f;
    }

    .feedback.bad {
      border-color: #efc0be;
      background: var(--bad-soft);
      color: #7e2522;
    }

    .success-flash {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid #b4e3cc;
      background: #e9fbf2;
      color: #0f5a3b;
      min-height: 58px;
      display: none;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 8px;
      padding: 8px 11px;
    }

    .success-flash.show {
      display: grid;
      animation: rise 0.22s ease;
    }

    .success-icon {
      width: 38px;
      height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 1.36rem;
      background: #c5f4dc;
      border: 1px solid #95d8b6;
    }

    .success-copy {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
      gap: 2px;
    }

    .success-main {
      font-weight: 900;
      font-size: 1.02rem;
    }

    .success-points {
      font-size: 0.84rem;
      color: #1c6f4a;
      font-weight: 800;
    }

    .hint-box {
      margin-top: 10px;
      border: 1px dashed #f0ba9b;
      background: var(--accent-soft);
      border-radius: 12px;
      padding: 9px 11px;
      color: #6e3a1a;
      display: none;
    }

    .hint-box p {
      margin: 4px 0;
    }

    .hint-box.show {
      display: block;
      animation: rise 0.26s ease;
    }

    .stats h2,
    .quick-help h2 {
      margin: 0 0 10px;
      font-size: 1.02rem;
      color: #1c3649;
    }

    .stat-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(2, 1fr);
      margin-bottom: 10px;
    }

    .stat {
      border: 1px solid #d4dfdb;
      border-radius: 12px;
      padding: 8px;
      background: #f9fcfb;
    }

    .stat strong {
      display: block;
      font-size: 1.28rem;
      font-family: "Baloo 2", "Nunito", sans-serif;
      color: #0f3a4b;
      line-height: 1;
    }

    .stat span {
      font-size: 0.83rem;
      color: #4f646d;
      font-weight: 700;
    }

    .motivation-box {
      border-radius: 12px;
      border: 1px solid #b9d7ce;
      background: #effaf6;
      padding: 9px 10px;
      color: #245242;
      font-size: 0.94rem;
      font-weight: 700;
      min-height: 72px;
      line-height: 1.35;
      display: flex;
      align-items: flex-start;
    }

    .motivation-box strong {
      color: #104a3d;
    }

    .quick-help ul {
      margin: 0;
      padding-left: 18px;
      color: #2c4450;
      line-height: 1.4;
    }

    .quick-help li + li {
      margin-top: 6px;
    }

    .correct-input {
      border-color: #4caf72 !important;
      background: #f2fbf5 !important;
      box-shadow: 0 0 0 3px rgba(22, 117, 61, 0.14);
    }

    .wrong-input {
      border-color: #d26c67 !important;
      background: #fff3f2 !important;
      box-shadow: 0 0 0 3px rgba(184, 47, 43, 0.12);
    }

    .spark {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 3px;
      opacity: 0;
      pointer-events: none;
      animation: spark 0.75s ease-out forwards;
      z-index: 3;
    }

    @keyframes spark {
      0% {
        transform: translate(0, 0) scale(0.85) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translate(var(--dx), var(--dy)) scale(1.15) rotate(180deg);
        opacity: 0;
      }
    }

    @keyframes rise {
      from {
        transform: translateY(4px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @media (max-width: 920px) {
      .workspace {
        grid-template-columns: 1fr;
      }
    }

    @media (min-width: 700px) {
      .field.grade {
        grid-column: span 3;
      }

      .field.modes {
        grid-column: span 9;
      }

      .field.auto {
        grid-column: span 12;
      }
    }

    @media (max-width: 560px) {
      body {
        padding: 10px;
      }

      .top {
        padding: 16px 14px 11px;
      }

      .brand-row {
        align-items: flex-start;
      }

      .brand-logo {
        height: clamp(38px, 10vw, 54px);
        max-width: 88vw;
      }

      .content {
        padding: 10px;
      }

      .answer-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="top">
      <div class="brand-row">
        <div class="brand-lockup" id="brandLockup">
          <img
            id="hkvLogo"
            class="brand-logo"
            src="HKV_Swiss_Logo.jpg"
            alt="HKV Swiss Logo"
          />
          <span class="brand-fallback" id="hkvFallback">HKV Swiss</span>
        </div>
        <span class="badge">Interaktive Mathe Zone</span>
      </div>
      <h1>Addition, Subtraktion, Multiplikation und Division</h1>
      <p class="lead">
        W√§hle Stufe und Rechenart, l√∂se Aufgaben mit Tipps und trainiere ohne Limit.
        Bei richtigen Antworten bekommst du direkt motivierendes Feedback.
      </p>
    </header>

    <div class="content">
      <section class="card controls" aria-label="Steuerung">
        <div class="field grade">
          <label for="gradeSelect">Schulstufe</label>
          <select id="gradeSelect">
            <option value="2">2. Klasse</option>
            <option value="3">3. Klasse</option>
          </select>
        </div>

        <div class="field modes">
          <label>Rechenart</label>
          <div class="mode-group" id="modeButtons">
            <button class="mode-btn active" type="button" data-mode="mix">Mix</button>
            <button class="mode-btn" type="button" data-mode="add">Addition</button>
            <button class="mode-btn" type="button" data-mode="sub">Subtraktion</button>
            <button class="mode-btn" type="button" data-mode="mul">Multiplikation</button>
            <button class="mode-btn" type="button" data-mode="div" id="divModeBtn">Division</button>
          </div>
        </div>

        <div class="field auto">
          <label>&nbsp;</label>
          <label class="auto-wrap">
            <input type="checkbox" id="autoNext" checked />
            Nach richtiger Antwort direkt weiter
          </label>
        </div>
      </section>

      <section class="workspace">
        <article class="card task-card" id="taskCard">
          <div class="task-meta">
            <span class="chip" id="chipGrade">2. Klasse</span>
            <span class="chip" id="chipMode">Mix</span>
          </div>

          <p class="equation" id="equation">12 + 5 = ?</p>

          <div class="answer-row">
            <input id="answerInput" type="number" inputmode="numeric" placeholder="Deine Antwort" aria-label="Antwort eingeben" />
            <button class="btn btn-main" id="checkBtn" type="button">Pr√ºfen</button>
            <button class="btn btn-ghost" id="newBtn" type="button">Neue Aufgabe</button>
          </div>

          <div class="sub-actions">
            <button class="btn btn-warn" id="hintBtn" type="button">Hinweis zeigen</button>
            <button class="btn btn-ghost" id="resetBtn" type="button">Punkte zur√ºcksetzen</button>
          </div>

          <div id="feedback" class="feedback">Starte mit der ersten Aufgabe.</div>
          <div id="successFlash" class="success-flash" aria-live="polite">
            <span class="success-icon" id="successIcon">üëç</span>
            <span class="success-copy">
              <span class="success-main" id="successMain">Stark!</span>
              <span class="success-points" id="successPoints">+10 Punkte</span>
            </span>
          </div>
          <div id="hintBox" class="hint-box" aria-live="polite"></div>
        </article>

        <aside class="card stats" aria-label="Fortschritt">
          <h2>Dein Fortschritt</h2>
          <div class="stat-grid">
            <div class="stat">
              <strong id="pointsStat">0</strong>
              <span>Punkte</span>
            </div>
            <div class="stat">
              <strong id="streakStat">0</strong>
              <span>Serie</span>
            </div>
            <div class="stat">
              <strong id="correctStat">0</strong>
              <span>Richtig</span>
            </div>
            <div class="stat">
              <strong id="accuracyStat">0%</strong>
              <span>Trefferquote</span>
            </div>
          </div>
          <div class="motivation-box" id="motivationBox">
            Du bist startklar. Erste Aufgabe l√∂sen und Flow aufbauen.
          </div>
        </aside>
      </section>

      <section class="card quick-help">
        <h2>Kurze Lernhilfe</h2>
        <ul>
          <li><strong>Addition:</strong> Starte mit der gr√∂√üeren Zahl und z√§hle den Rest dazu.</li>
          <li><strong>Subtraktion:</strong> Frage dich, wie viel bis zur gr√∂√üeren Zahl fehlt.</li>
          <li><strong>Multiplikation:</strong> Denke als wiederholte Addition oder Nachbaraufgabe.</li>
          <li><strong>Division:</strong> Denke r√ºckw√§rts mit Multiplikation (ab 3. Klasse).</li>
          <li><strong>Tipp:</strong> Mit dem Button <em>Neue Aufgabe</em> kannst du endlos trainieren.</li>
        </ul>
      </section>
    </div>
  </main>

  <script>
    (function () {
      const modeLabels = {
        mix: "Mix",
        add: "Addition",
        sub: "Subtraktion",
        mul: "Multiplikation",
        div: "Division"
      };

      const successShort = [
        "Stark!",
        "Top!",
        "Boom!",
        "Yes!",
        "Nice!",
        "Weiter!"
      ];

      const encourage = [
        "Fast, probiere es noch einmal.",
        "Guter Versuch. Mit einem Hinweis klappt es.",
        "Bleib dran, du bist n√§her dran als du denkst.",
        "Weiter so, jeder Versuch macht dich besser."
      ];

      const storyStages = [
        {
          minCorrect: 0,
          title: "Mission Start",
          text: "L√∂se 3 Aufgaben und starte dein erstes Mathe-Kapitel."
        },
        {
          minCorrect: 3,
          title: "Kapitel 1: Rechen-Rookie",
          text: "Starker Einstieg. Halte die Konzentration und baue deine Serie aus."
        },
        {
          minCorrect: 8,
          title: "Kapitel 2: Zahlen-Navigator",
          text: "Du steuerst sicher durch die Aufgaben. N√§chstes Ziel: 70% Trefferquote."
        },
        {
          minCorrect: 15,
          title: "Kapitel 3: Fokus-Profi",
          text: "Richtig stark. Du bist in einem echten Lern-Flow."
        },
        {
          minCorrect: 25,
          title: "Kapitel 4: Rechen-Champion",
          text: "Top-Niveau. Deine Routine ist jetzt deutlich sichtbar."
        }
      ];

      const state = {
        grade: 2,
        mode: "mix",
        currentTask: null,
        hintIndex: 0,
        attempts: 0,
        correct: 0,
        streak: 0,
        points: 0,
        successTimer: null
      };

      const gradeSelect = document.getElementById("gradeSelect");
      const modeButtons = document.getElementById("modeButtons");
      const divModeBtn = document.getElementById("divModeBtn");
      const brandLockup = document.getElementById("brandLockup");
      const hkvLogo = document.getElementById("hkvLogo");
      const hkvFallback = document.getElementById("hkvFallback");
      const chipGrade = document.getElementById("chipGrade");
      const chipMode = document.getElementById("chipMode");
      const equation = document.getElementById("equation");
      const answerInput = document.getElementById("answerInput");
      const checkBtn = document.getElementById("checkBtn");
      const newBtn = document.getElementById("newBtn");
      const hintBtn = document.getElementById("hintBtn");
      const resetBtn = document.getElementById("resetBtn");
      const autoNext = document.getElementById("autoNext");
      const feedback = document.getElementById("feedback");
      const successFlash = document.getElementById("successFlash");
      const successIcon = document.getElementById("successIcon");
      const successMain = document.getElementById("successMain");
      const successPoints = document.getElementById("successPoints");
      const hintBox = document.getElementById("hintBox");
      const taskCard = document.getElementById("taskCard");
      const pointsStat = document.getElementById("pointsStat");
      const streakStat = document.getElementById("streakStat");
      const correctStat = document.getElementById("correctStat");
      const accuracyStat = document.getElementById("accuracyStat");
      const motivationBox = document.getElementById("motivationBox");

      function initBranding() {
        const logoCandidates = [
          "HKV_Swiss_Logo.jpg",
          "HKV_Swiss_Logo.svg",
          "HKV_Swiss_Logo.png",
          "hkv-logo-swiss.jpg",
          "hkv_swiss_logo.svg",
          "hkv_swiss_logo.png"
        ];
        let logoIndex = 0;

        function showFallback() {
          brandLockup.classList.add("no-logo");
          hkvFallback.textContent = "HKV Swiss";
        }

        function showLogo() {
          brandLockup.classList.remove("no-logo");
        }

        hkvLogo.addEventListener("error", function () {
          logoIndex += 1;
          if (logoIndex < logoCandidates.length) {
            hkvLogo.src = logoCandidates[logoIndex];
            return;
          }
          showFallback();
        });
        hkvLogo.addEventListener("load", showLogo);

        if (hkvLogo.complete) {
          if (hkvLogo.naturalWidth > 0) {
            showLogo();
          } else {
            logoIndex = 1;
            if (logoIndex < logoCandidates.length) {
              hkvLogo.src = logoCandidates[logoIndex];
            } else {
              showFallback();
            }
          }
        } else {
          hkvLogo.src = logoCandidates[logoIndex];
        }
      }

      function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function pick(list) {
        return list[randomInt(0, list.length - 1)];
      }

      function splitNumber(n) {
        const abs = Math.abs(n);
        const parts = [];
        const thousands = Math.floor(abs / 1000);
        const hundreds = Math.floor((abs % 1000) / 100);
        const tens = Math.floor((abs % 100) / 10);
        const ones = abs % 10;

        if (thousands) parts.push(String(thousands * 1000));
        if (hundreds) parts.push(String(hundreds * 100));
        if (tens) parts.push(String(tens * 10));
        if (ones || parts.length === 0) parts.push(String(ones));

        return parts.join(" + ");
      }

      function setFeedback(text, type) {
        feedback.textContent = text;
        feedback.classList.remove("ok", "bad");
        if (type === "ok") feedback.classList.add("ok");
        if (type === "bad") feedback.classList.add("bad");
      }

      function showSuccess(pointsWon) {
        successIcon.textContent = "üëç";
        successMain.textContent = pick(successShort);
        successPoints.textContent = "+" + pointsWon + " Punkte";
        successFlash.classList.add("show");

        if (state.successTimer) {
          window.clearTimeout(state.successTimer);
        }
        state.successTimer = window.setTimeout(function () {
          successFlash.classList.remove("show");
        }, 2500);
      }

      function syncDivisionVisibility() {
        const showDivision = state.grade >= 3;
        divModeBtn.style.display = showDivision ? "" : "none";
        if (!showDivision && state.mode === "div") {
          state.mode = "mix";
        }
      }

      function renderHints() {
        if (!state.currentTask || state.hintIndex === 0) {
          hintBox.classList.remove("show");
          hintBox.innerHTML = "";
          hintBtn.textContent = "Hinweis zeigen";
          return;
        }

        const hints = state.currentTask.hints.slice(0, state.hintIndex);
        hintBox.innerHTML = hints.map(function (h, i) {
          return "<p><strong>Hinweis " + (i + 1) + ":</strong> " + h + "</p>";
        }).join("");
        hintBox.classList.add("show");
        hintBtn.textContent = state.hintIndex >= state.currentTask.hints.length ? "Alle Hinweise gezeigt" : "Weiterer Hinweis";
      }

      function updateStats() {
        pointsStat.textContent = String(state.points);
        streakStat.textContent = String(state.streak);
        correctStat.textContent = String(state.correct);

        const accuracy = state.attempts > 0 ? Math.round((state.correct / state.attempts) * 100) : 0;
        accuracyStat.textContent = accuracy + "%";

        let stage = storyStages[0];
        storyStages.forEach(function (entry) {
          if (state.correct >= entry.minCorrect) stage = entry;
        });

        let bonus = "";
        if (state.streak >= 5) {
          bonus = " Bonus: " + state.streak + "er-Serie. Unbedingt dranbleiben!";
        } else if (state.attempts >= 5 && accuracy >= 80) {
          bonus = " Bonus: Starke Quote mit " + accuracy + "%.";
        } else if (state.correct > 0) {
          bonus = " N√§chstes Mini-Ziel: noch 2 richtige Antworten am St√ºck.";
        }

        motivationBox.innerHTML = "<strong>" + stage.title + "</strong><br>" + stage.text + bonus;
      }

      function normalizeSubtraction(a, b) {
        return a >= b ? [a, b] : [b, a];
      }

      function createAdditionTask(grade) {
        let a;
        let b;
        if (grade === 2) {
          a = randomInt(8, 80);
          b = randomInt(3, 35);
          while (a + b > 100) {
            a = randomInt(8, 80);
            b = randomInt(3, 35);
          }
        } else {
          a = randomInt(120, 940);
          b = randomInt(60, 760);
          while (a + b > 1500) {
            a = randomInt(120, 940);
            b = randomInt(60, 760);
          }
        }

        const smaller = Math.min(a, b);
        const bigger = Math.max(a, b);
        const answer = a + b;

        return {
          mode: "add",
          text: a + " + " + b + " = ?",
          answer: answer,
          hints: [
            "Starte bei " + bigger + " und z√§hle " + smaller + " dazu.",
            "Zerlege " + smaller + " in " + splitNumber(smaller) + " und addiere Schritt f√ºr Schritt.",
            "Kontrolle: Das Ergebnis liegt zwischen " + bigger + " und " + (bigger + smaller + 1) + "."
          ]
        };
      }

      function createSubTask(grade) {
        let a;
        let b;
        if (grade === 2) {
          a = randomInt(15, 100);
          b = randomInt(2, 90);
          const pair = normalizeSubtraction(a, b);
          a = pair[0];
          b = pair[1];
        } else {
          a = randomInt(190, 1300);
          b = randomInt(45, 990);
          const pair = normalizeSubtraction(a, b);
          a = pair[0];
          b = pair[1];
        }

        const answer = a - b;

        return {
          mode: "sub",
          text: a + " - " + b + " = ?",
          answer: answer,
          hints: [
            "Frage dich: Welche Zahl m√ºsstest du zu " + b + " addieren, um auf " + a + " zu kommen?",
            "Ziehe " + splitNumber(b) + " von " + a + " in Schritten ab.",
            "Schnellcheck: Ergebnis plus " + b + " muss wieder " + a + " ergeben."
          ]
        };
      }

      function createMulTask(grade) {
        let a;
        let b;
        if (grade === 2) {
          a = randomInt(1, 10);
          b = randomInt(1, 10);
        } else {
          a = randomInt(3, 14);
          b = randomInt(3, 16);
          while (a * b > 240) {
            a = randomInt(3, 14);
            b = randomInt(3, 16);
          }
        }

        const answer = a * b;
        const neighbor = b > 1 ? (a + " x " + (b - 1) + " + " + a) : (a + " x " + (b + 1) + " - " + a);

        return {
          mode: "mul",
          text: a + " x " + b + " = ?",
          answer: answer,
          hints: [
            "Denke als wiederholte Addition: " + a + " wird " + b + "-mal addiert.",
            "Nutze eine Nachbaraufgabe: " + a + " x " + b + " = " + neighbor + ".",
            "Schnellcheck: " + answer + " geteilt durch " + a + " ergibt " + b + "."
          ]
        };
      }

      function createDivTask() {
        const divisor = randomInt(2, 12);
        const result = randomInt(2, 12);
        const dividend = divisor * result;

        return {
          mode: "div",
          text: dividend + " : " + divisor + " = ?",
          answer: result,
          hints: [
            "Denke r√ºckw√§rts: " + divisor + " x ? = " + dividend + ".",
            "Suche die Zahl, die mit " + divisor + " multipliziert " + dividend + " ergibt.",
            "Schnellcheck: " + result + " x " + divisor + " = " + dividend + "."
          ]
        };
      }

      function generateTask() {
        answerInput.value = "";
        answerInput.classList.remove("correct-input", "wrong-input");
        state.hintIndex = 0;
        renderHints();

        syncDivisionVisibility();
        const mixModes = state.grade >= 3 ? ["add", "sub", "mul", "div"] : ["add", "sub", "mul"];
        const mode = state.mode === "mix" ? pick(mixModes) : state.mode;
        let task;
        if (mode === "add") task = createAdditionTask(state.grade);
        if (mode === "sub") task = createSubTask(state.grade);
        if (mode === "mul") task = createMulTask(state.grade);
        if (mode === "div") task = createDivTask();

        state.currentTask = task;
        equation.textContent = task.text;
        chipGrade.textContent = state.grade + ". Klasse";
        chipMode.textContent = modeLabels[mode];
        setFeedback("Neue Aufgabe geladen. Gib deine Antwort ein.", null);
        answerInput.focus();
      }

      function burst() {
        const colors = ["#0aa88d", "#f16a2d", "#ffd166", "#0f7394"];
        for (let i = 0; i < 14; i += 1) {
          const spark = document.createElement("span");
          spark.className = "spark";
          spark.style.background = pick(colors);
          spark.style.left = (40 + randomInt(-18, 18)) + "%";
          spark.style.top = (32 + randomInt(-8, 8)) + "%";
          spark.style.setProperty("--dx", randomInt(-130, 130) + "px");
          spark.style.setProperty("--dy", randomInt(-70, 120) + "px");
          taskCard.appendChild(spark);
          window.setTimeout(function () {
            spark.remove();
          }, 780);
        }
      }

      function checkAnswer() {
        if (!state.currentTask) return;

        const raw = answerInput.value.trim();
        if (!raw.length) {
          setFeedback("Bitte erst eine Zahl eingeben.", "bad");
          answerInput.classList.remove("correct-input");
          answerInput.classList.add("wrong-input");
          return;
        }

        const guess = Number(raw);
        if (!Number.isFinite(guess)) {
          setFeedback("Das ist keine g√ºltige Zahl.", "bad");
          answerInput.classList.remove("correct-input");
          answerInput.classList.add("wrong-input");
          return;
        }

        state.attempts += 1;

        if (guess === state.currentTask.answer) {
          state.correct += 1;
          state.streak += 1;
          const pointsWon = 8 + Math.min(16, state.streak * 2);
          state.points += pointsWon;
          answerInput.classList.remove("wrong-input");
          answerInput.classList.add("correct-input");
          setFeedback("Richtig! +" + pointsWon + " Punkte.", "ok");
          showSuccess(pointsWon);
          burst();
          updateStats();

          if (autoNext.checked) {
            window.setTimeout(generateTask, 900);
          }
        } else {
          state.streak = 0;
          state.points = Math.max(0, state.points - 2);
          answerInput.classList.remove("correct-input");
          answerInput.classList.add("wrong-input");
          setFeedback(pick(encourage) + " Tipp: Nutze bei Bedarf einen Hinweis.", "bad");
          updateStats();
        }
      }

      function setMode(mode) {
        if (mode === "div" && state.grade < 3) {
          return;
        }
        state.mode = mode;
        const buttons = modeButtons.querySelectorAll(".mode-btn");
        buttons.forEach(function (btn) {
          btn.classList.toggle("active", btn.dataset.mode === mode);
        });
        chipMode.textContent = modeLabels[mode];
        generateTask();
      }

      function resetProgress() {
        state.attempts = 0;
        state.correct = 0;
        state.streak = 0;
        state.points = 0;
        updateStats();
        setFeedback("Punkte wurden zur√ºckgesetzt. Neue Runde startet.", null);
        generateTask();
      }

      gradeSelect.addEventListener("change", function () {
        state.grade = Number(gradeSelect.value);
        syncDivisionVisibility();
        if (state.grade < 3 && state.mode === "div") {
          setMode("mix");
          return;
        }
        generateTask();
      });

      modeButtons.addEventListener("click", function (event) {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        if (!target.classList.contains("mode-btn")) return;
        setMode(target.dataset.mode);
      });

      checkBtn.addEventListener("click", checkAnswer);
      newBtn.addEventListener("click", generateTask);
      resetBtn.addEventListener("click", resetProgress);

      hintBtn.addEventListener("click", function () {
        if (!state.currentTask) return;
        if (state.hintIndex < state.currentTask.hints.length) {
          state.hintIndex += 1;
          renderHints();
        } else {
          setFeedback("Du hast bereits alle Hinweise gesehen.", null);
        }
      });

      answerInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          checkAnswer();
        }
      });

      initBranding();
      updateStats();
      syncDivisionVisibility();
      generateTask();
    })();
  </script>
</body>
</html>
